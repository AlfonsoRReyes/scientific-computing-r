---
title: "The making of RBall game class"
output:
  html_document: default
  html_notebook: default
---

The application has three main classes:
* the player represented by the class `Player` which defines the characteristics of each player in the game

* the game represented by the class `RBallGame` which 


## Player methods
    * show: info of any player
    * initialize: score, probability per player and ID
    * winsServe: decide who wins this hand (random)
    * incScore: increment the score in 1 if player wins
    * getScore: get the current score
    * whois: returns the player ID

# RBallGame methods
    initialize: define the players and who plays first
    play: play the game until is over (loop). 
          If player wins, increment score.
          then, switch server.
    isOver: game over if player reaches 15, or one player wins by 7-0.
    changeServer: switch player after a win
    getScores: get the current score for all players.

## SimStats methods
    initialize: initialize wins, shuts and games for players
    Update: tracks number of games, wins and shuts
    printReport: print games, wins and shuts for players


## Game controller (use of the classes)
    n =   5
    stats <- SimStats()   # start the statistics; clear all
    for (i in 1:n) {      # play `n` games
        theGame <- RBallGame(0.5, 0.5, verbose = TRUE)  # start the game
        theGame <- play(theGame)                        # play the game
        stats <- Update(stats, theGame)                 # update the statistics
    }
    printReport(stats)                                  # print the report


```{r}
# Racquetball classes
# from Python to R S4 classes

setClass("Player",
    slots = c(prob = "numeric",
              score = "numeric",
              ID = "character"),
    prototype = list(prob = 0.5,
                     score = 0,
                     ID = "X"
    ))


setClass("RBallGame",
         slots = c(
             PlayerA = "Player",
             PlayerB = "Player",
             server  = "Player"
    ))

setClass("SimStats",
    slots = c(
        winsA  = "numeric",
        winsB  = "numeric",
        shutsA = "numeric",
        shutsB = "numeric",
        games  = "numeric"
    )
)

#' function to compare if two S4 objects are the same
id <- function(a,b){
    sapply(slotNames(a),function(x)identical(slot(a,x),slot(b,x)))
}


# generic functions for Player methods
setGeneric("winsServe", function(object, ...) standardGeneric("winsServe"))
setGeneric("incScore", function(object, ...) standardGeneric("incScore"))
setGeneric("getScore", function(object, ...) standardGeneric("getScore"))
setGeneric("whois", function(object, ...) standardGeneric("whois"))

# generics functions for RBallGame
setGeneric("play", function(object, ...) standardGeneric("play"))
setGeneric("isOver", function(object, ...) standardGeneric("isOver"))
setGeneric("changeServer", function(object, ...) standardGeneric("changeServer"))
setGeneric("getScores", function(object, ...) standardGeneric("getScores"))

# generic functions for SimStats
setGeneric("Update", function(object, aGame) standardGeneric("Update"))
setGeneric("printReport", function(object, ...) standardGeneric("printReport"))
setGeneric("printLine", function(object, ...) standardGeneric("printLine"))

###############################################################################
# methods for Player class
setMethod("show",
          signature = "Player",
          definition = function(object) {
              cat("An object of class ", class(object), "\n", sep = "")
              cat("Prob: ", object@prob, " ID: ", object@ID,
                  " Score: ", object@score, sep = "")
          })


setMethod("initialize", "Player", function(.Object, prob, ID){
    .Object@score <- 0
    .Object@prob  <- prob
    .Object@ID    <-  ID
    return(.Object)
})

setMethod("winsServe", "Player", function(object) {
    ru <- runif(1)
    return(runif(1) <= object@prob)})

setMethod("incScore", "Player", function(object) {
    object@score <- object@score + 1
    # return(object@score)
    object
})

setMethod("getScore", "Player", function(object) {
    return(object@score)})

setMethod("whois", "Player", function(object) {
    return(object@ID)
})


###############################################################################
# set methods for RBAllGame class
setMethod("initialize", "RBallGame",
    function(.Object, ..., probA = 0.5, probB = 0.5){
        .Object@PlayerA <- Player(prob = probA, ID = "A")
        .Object@PlayerB <- Player(prob = probB, ID = "B")
        .Object@server <- .Object@PlayerA
        return(.Object)
})



setMethod("play", "RBallGame", function(object) {
    # This implementation is different in Python. In R, values between methods
    # are passed by value not reference as in Python.
    if (RBall.env[["verbose"]]) cat(sprintf("%35s %7s %7s %8s %8s \n", 
                                            "#", "Player", "Done", "Score A", 
                                            "Score B"))
    i <- 1
    while (!isOver(object)) {
        if (winsServe(object@server)) {
            if (whois(object@server) == "A") 
                object@PlayerA <- incScore(object@PlayerA) # explicit assignment
            else
                object@PlayerB <- incScore(object@PlayerB) # explicit assignment
        } else {
            object <- changeServer(object)                 # explicit assignment
        }
        if (RBall.env[["verbose"]]) cat(sprintf("%35d %7s %7s %8d %8d \n", 
                            i, whois(object@server), isOver(object), 
                            getScore(object@PlayerA), getScore(object@PlayerB)))
        i <- i + 1
    }
    object
})

setMethod("isOver", "RBallGame", function(object) {
    score <- getScores(object)
    a <- score[["A"]]
    b <- score[["B"]]
    done <- a == 15 || b == 15 || (a == 7 && b == 0) || (b == 7 && a == 0)
    return(done)
})

setMethod("changeServer", "RBallGame", function(object) {
    if (slot(object@server, "ID") == "A") {
        object@server <-  object@PlayerB
    } else {
        object@server <- object@PlayerA
    }
    object
})

setMethod("getScores", "RBallGame", function(object) {
    return(list(A = getScore(object@PlayerA), 
                B = getScore(object@PlayerB)))
})




###############################################################################
# set method for SimStats class
setMethod("initialize", "SimStats",
          function(.Object, ...) {
              .Object@winsA  <- 0
              .Object@winsB  <- 0
              .Object@shutsA <- 0
              .Object@shutsB <- 0
              .Object@games  <- 0
              # header for report
              cat("-------- Scores -------- \n")
              cat(sprintf("%7s %7s %7s \n", "Game", "A", "B"))
              return(.Object)
          })

setMethod("Update", "SimStats", function(object, aGame) {
    object@games <- object@games + 1
    a <- getScores(aGame)[["A"]]
    b <- getScores(aGame)[["B"]]
    cat(sprintf("%7d %7d %7d \n", object@games, a, b))
    if (a > b) {
        object@winsA <- object@winsA + 1
        if (b == 0)
            object@shutsA <- object@shutsA + 1
    } else {
        object@winsB <- object@winsB + 1
        if (a == 0)
            object@shutsB <- object@shutsB + 1
    }
    object
})

setMethod("printReport", "SimStats", function(object) {
    n <- object@winsA + object@winsB
    cat("\nNumber of games:", n, "\n")
    cat(sprintf("%7s %5s %5s \n", "Player", "Wins", "Shuts"))
    cat(sprintf("%7s %5d %5d \n", "A", object@winsA, object@shutsA))
    cat(sprintf("%7s %5d %5d \n", "B", object@winsB, object@shutsB))
})

setMethod("printLine", "SimStats", function(object, aGame) {
})



```

```{r}
# create a project environment
RBall.env <- new.env(parent = emptyenv()) # create new environment

# constructors
Player <- function(prob, ID) new("Player", prob = prob, ID = ID)

RBallGame <- function(probA, probB, verbose = FALSE) {
    # use an environment to pass the verbose flag for printing
    RBall.env[["verbose"]] <- verbose
    new("RBallGame", probA = probA, probB = probB)
} 

SimStats <- function() new("SimStats")
```




```{r}
# The whole program using S4 classes
n <-  5        # play five or fifty games

# Each game ends when a player defeats another by 7-0 or the first that reaches 15 points.

stats <- SimStats()
for (i in 1:n) {
    theGame <- RBallGame(0.5, 0.5, verbose = TRUE)
    theGame <- play(theGame)
    stats <- Update(stats, theGame)
}
printReport(stats)
```






```{r}
setClass("Player", 
         slots = c(
            prob = "numeric",
            score = "numeric"), 
        prototype = list(
            prob = 0.5,
            score = 0
    ))


setClass("RBallGame", slots = c(
    PlayerA = "Player", 
    PlayerB = "Player", 
    server  = "Player")
         )

setClass("SimStats", slots = c(
    winsA = "numeric",
    winsB = "numeric",
    shutsA = "numeric",
    shutsB = "numeric"
))

#' function to compare if two S4 objects are the same
id <- function(a,b){
        sapply(slotNames(a),function(x)identical(slot(a,x),slot(b,x)))
        }


# generic for Player methods
setGeneric("winsServe", function(object, ...) standardGeneric("winsServe"))
setGeneric("incScore", function(object, ...) standardGeneric("incScore"))
setGeneric("getScore", function(object, ...) standardGeneric("getScore"))

# generics for RBallGame
setGeneric("play", function(object, ...) standardGeneric("play"))
setGeneric("isOver", function(object, ...) standardGeneric("isOver"))
setGeneric("changeServer", function(object, ...) standardGeneric("changeServer"))
setGeneric("getScores", function(object, ...) standardGeneric("getScores"))

# generic function for SimStats
setGeneric("update", function(object, aGame) standardGeneric("update"))
setGeneric("printReport", function(object, ...) standardGeneric("printReport"))
setGeneric("printLine", function(object, ...) standardGeneric("printLine"))


# methods for Player
# setMethod("initialize", "Player",
#           function(.Object, ..., prob){
#               # callNextMethod(.Object, ...)
#               .Object@score <- 0
#               .Object@prob <- prob
#               return(.Object)
#           })

setMethod("winsServe", "Player", function(object) {
    ru <- runif(1)
    return(runif(1) <= object@prob)})

setMethod("incScore", "Player", function(object) {
    object@score <- object@score + 1
    return(object)
    })

setMethod("getScore", "Player", function(object) {
    return(object@score)})


# Player <- function(prob) new("Player", prob = prob)
# p <- Player(0.5)



#############################################################################
# set methods for RBAllGame
setMethod("initialize", "RBallGame",
          function(.Object, ..., probA = 0.5, probB = 0.5){
            .Object@PlayerA <- Player(probA)
            .Object@PlayerB <- Player(probB)
            .Object@server <- .Object@PlayerA
            #callNextMethod(.Object, ...)
            return(.Object)
          })

setMethod("play", "RBallGame", function(object) {
    i = 1
    while (!isOver(object)) {
        i <-  i + 1
        cat(i)
        if (i > 20) break
        if (winsServe(object@server))
            object@server <- incScore(object@server)
        else
            changeServer(object)
        
    }
    return(object)
})

setMethod("isOver", "RBallGame", function(object) {
    os <- getScores(object)
    a <- os[["A"]]
    b <- os[["B"]]
    # cat(a, b)
    res <- a == 15 || b == 15 || (a == 7 && b == 0) || (b == 7 && a == 0)
    return(res)
    })

setMethod("changeServer", "RBallGame", function(object) {
  if (all(id(object@server, object@PlayerA))) {
      object@server <-  object@PlayerB
      cat(getScore(object@PlayerB), "playerB\n")
  }  else {
      object@server <- object@PlayerA
      cat(getScore(object@PlayerB), "playerA\n")
  }
  #return(object)
})

setMethod("getScores", "RBallGame", function(object) {
    A <- getScore(object@PlayerA)
    B <- getScore(object@PlayerB)
    return(list(A = A, B = B))
    # return(object)
    })

# RBallGame <- function(probA, probB) new("RBallGame", probA = probA, probB = probB)

########################################################################################



# set method for SimStats
setMethod("initialize", "SimStats",
          function(.Object, ...) {
              .Object@winsA <- 0
              .Object@winsB <- 0
              .Object.shutsA <-  0
              .Object.shutsB <-  0
              #callNextMethod(.Object, ...)
              return(.Object)
          })

setMethod("update", "SimStats", function(object, aGame) {
              a <- getScores(aGame)[["A"]]
              b <- getScores(aGame)[["B"]]
              cat("scores", a, b, "\n")
              if (a > b) {
                  object@winsA <- object@winsA + 1
                  if (b == 0)
                      object@shutsA <- object@shutsA + 1
              } else {
                  object@winsB <- object@winsB + 1
                  if (a == 0)
                      object@shutsB <- object@shutsB + 1
              }
              return(object)
          })

# constructors
Player <- function(prob) new("Player", prob = prob)
RBallGame <- function(probA, probB) new("RBallGame", probA = probA, probB = probB)
SimStats <- function() new("SimStats")

# Player <- function(prob) new("Player", prob = prob)
# RBallGame <- function(probA, probB) new("RBallGame", probA = probA, probB = probB)
# 
# rb <- RBallGame(0.4, 0.6)
# getScores(rb)
# isOver(rb)
# play(rb)
# changeServer(rb)
# play(rb)


# rb <- RBallGame(0.4, 0.6)
```


```{r}
game <- RBallGame(0.4, 0.6)
game <- play(game)
```

```{r}
a = 8
b = 7
res <- a == 15 || b == 15 || (a == 7 && b == 0) || (b == 7 && a == 0)
res
```


```{r}
FchangeServer <- function(game) {
    if (all(id(game@server, game@PlayerA))) {
        game@server <- game@PlayerB
        cat("Player B now serving \n")
    } else {
        game@server <- game@PlayerA
        cat("Player A now serving \n")
}
    return(game)
}
```


```{r}
n <-  50
game <- RBallGame(0.4, 0.6)



```

```{r}
print(game@server)
if (winsServe(game@server))  {
    game <- incScore(game@server) 
    #getScore(game)
} else {
    game <- FchangeServer(game)
}    
```


```{r}
winsServe(p)
#incScore(p)
p <- incScore(p)
getScore(p)
#getScore(p)
```

```{r}
# new incremental value needs to be saved to `p`
p <- incScore(p)
getScore(p)
```



```{r}
n <-  50
p <- Player(0.5)

for (i in (1:n)) {
    if (winsServe(p)) p <- incScore(p)
    cat(i, getScore(p), "\n")
    # cat(i, winsServe(p), "\n")
}
```






```{r}
n <-  10
game <- RBallGame(0.4, 0.6)
for (i in (1:n)) {
    # game <- RBallGame(0.4, 0.6)
   game <- play(game)
    cat(isOver(game))
    cat("\t", getScores(game)$A, getScores(game)$B, "\n")
}    
```





```{r}
# test play
n <-  50
game <- RBallGame(0.4, 0.6)
p1 <- game@PlayerA
p2 <- game@PlayerB

for (i in (1:n)) {
    if (winsServe(p1)) 
        p1 <- incScore(p1)
    else 
        p2 <- incScore(p2)
    cat(i, getScore(p1), getScore(p2), "\n")
}    
```



```{r}
# test RBallGame methods
n <-  50
game <- RBallGame(0.4, 0.6)
p1 <- game@PlayerA
p2 <- game@PlayerB

for (i in (1:n)) {
    if (winsServe(p1)) p1 <- incScore(p1)
    if (winsServe(p2)) p2 <- incScore(p2)
    cat(i, getScore(p1), getScore(p2))
    cat("\t", getScores(game)$A, getScores(game)$B, "\n")
}
```


```{r}
rb <- play(rb)
rb@PlayerA
rb@PlayerB
isOver(rb)
```


```{r}


# stats <-  SimStats()
# theGame <-  RBallGame(0.5, 0.511)
# play(theGame)
# # getScores(theGame)
# update(stats, theGame)
```

```{r}
probA <- 0.5
probB <-  0.511
n = 50
for (i in (1:n)) {
    theGame <- RBallGame(probA, probB)
    theGame <- play(theGame)
    cat(getScores(theGame)$A, getScores(theGame)$B)
    # stats <- update(stats, theGame)
}
    
```



```{r}
p <-  Player(0.45)
winsServe(p)
inScore(p)
getScore(p)
```

```{r}
setMethod("update", "SimStats", function(object, aGame) {
    a <- aGame.getScores()
    b <- aGame.getScores()
})
```

