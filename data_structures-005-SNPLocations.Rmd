

http://www.stat.wvu.edu/~jharner/courses/stat523/notesFall13/snpS4.zip

```{r setup, include=FALSE, error=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=TRUE, comment=NA, error=TRUE, warning=FALSE, 
                      message = FALSE, fig.align = 'center')
```

# Implementing an S4 class: SNP example

## Class definition

```{r}
setClass("SNPLocations",
    representation(
      genome="character", # a single string
      snpid="character",  # a character vector of length N
      chrom="character",  # a character vector of length N
      pos="integer"       # an integer vector of length N
      )
)
```


## Constructor
```{r}
SNPLocations <- function(genome, snpid, chrom, pos)
  new("SNPLocations", genome=genome, snpid=snpid, chrom=chrom, pos=pos)

snplocs <- SNPLocations("hg19",
    c("rs0001", "rs0002"),
    c("chr1", "chrX"),
    c(224033L, 1266886L))
snplocs
```

## Defining the length method
```{r}
setMethod("length", "SNPLocations", function(x) length(x@snpid))
length(snplocs) # just testing
```

## Defining the slot getters
```{r}
setGeneric("genome", function(x) standardGeneric("genome"))
setMethod("genome", "SNPLocations", function(x) x@genome)

setGeneric("snpid", function(x) standardGeneric("snpid"))
setMethod("snpid", "SNPLocations", function(x) x@snpid)

setGeneric("chrom", function(x) standardGeneric("chrom"))
setMethod("chrom", "SNPLocations", function(x) x@chrom)

setGeneric("pos", function(x) standardGeneric("pos"))
setMethod("pos", "SNPLocations", function(x) x@pos)

genome(snplocs) # just testing
snpid(snplocs) # just testing
```

## Defining the show method
```{r}
setMethod("show", "SNPLocations",
    function(object)
      cat(class(object), "instance with", length(object),
          "SNPs on genome", genome(object), "\n")
)
snplocs # just testing
```

## Defining the validity method
```{r}
setValidity("SNPLocations",
    function(object) {
      if (!is.character(genome(object)) || length(genome(object)) != 1 ||
            is.na(genome(object)))
          return("'genome' slot must be a single string")
      slot_lengths <- c(length(snpid(object)),
                        length(chrom(object)),
                        length(pos(object)))
      if (length(unique(slot_lengths)) != 1)
          return("lengths of slots 'snpid', 'chrom' and 'pos' differ")
      TRUE
      }
)

# this direct assignment to the slot works
snplocs@chrom <- LETTERS[1:3] # a very bad idea!

# but is not valid
validObject(snplocs)
```

```{r}
validObject(snplocs)
```



## Defining slot setters

```{r}
setGeneric("chrom<-", function(x, value) standardGeneric("chrom<-"))
setReplaceMethod("chrom", "SNPLocations",
  function(x, value) {x@chrom <- value; validObject(x); x})

chrom(snplocs) <- LETTERS[1:2] # repair currently broken object
chrom(snplocs)

# this will break because only two letters allowed
chrom(snplocs) <- LETTERS[1:3] # try to break it again
```


## Defining a coercion method
```{r}
setAs("SNPLocations", "data.frame",
  function(from)
    data.frame(snpid=snpid(from), chrom=chrom(from), pos=pos(from))
)
as(snplocs, "data.frame") # testing
```


# Slot Inheritance
```{r}
setClass("AnnotatedSNPs",
  contains="SNPLocations",
  representation(
  geneid="character" # a character vector of length N
  )
)
```


## The slots from the parent class are inherited:

```{r}
showClass("AnnotatedSNPs")
```

## Constructor
```{r}
AnnotatedSNPs <- function(genome, snpid, chrom, pos, geneid)
 {
 new("AnnotatedSNPs",
 SNPLocations(genome, snpid, chrom, pos),
 geneid=geneid)
 }
```


### Let’s create an AnnotatedSNPs object:

```{r}
snps <- AnnotatedSNPs("hg19",
  c("rs0001", "rs0002"),
  c("chr1", "chrX"),
  c(224033L, 1266886L),
  c("AAU1", "SXW-23"))
```


### All the methods deﬁned for SNPLocations objects work out-of-the-box:

```{r}
snps
```

### But sometimes they don’t do the right thing:

```{r}
as(snps, "data.frame") # the 'geneid' slot is ignored
```

### Being a SNPLocations object vs being a SNPLocations instance:

```{r}
is(snps, "AnnotatedSNPs") # 'snps' is an AnnotatedSNPs object
```

```{r}
is(snps, "SNPLocations") # and is also a SNPLocations object
```


```{r}
class(snps) # but is *not* a SNPLocations *instance*
```


# Method overriding
for example we could deﬁne a show method for
AnnotatedSNPs objects. callNextMethod can be used in that context to
call the method deﬁned for the parent class from within the method for
the child class.

## Automatic coercion method:

```{r}
as(snps, "SNPLocations")
```


# Incremental validity method
The validity method for AnnotatedSNPs objects only needs to validate
what’s not already validated by the validity method for SNPLocations
objects:

```{r}
setValidity("AnnotatedSNPs",
function(object) {
  if (length(object@geneid) != length(object))
  return("'geneid' slot must have the length of the object")
  TRUE
  }
)
```

In other words: before an AnnotatedSNPs object can be considered valid,
it must ﬁrst be a valid SNPLocations object.

```{r}

```

